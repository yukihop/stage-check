<!html>
<head>
<meta charset="utf-8">
<title>Cinderella Stage Clear Checker</title>

<style>
h1 { font-size: 100%; }
table { border-collapse: collapse; }
td, th { border: 1px solid silver; }
tr.all { background: linear-gradient(to bottom, #fee, #eef, #ffe); }
tr.cute { background-color: #ffdddd; }
tr.cool { background-color: #ddddff; }
tr.passion { background-color: #ffffdd; }
#summary { font-weight: bold; padding: 0.5em; }

table label { display: inline-block; width: 100px; text-align: center; box-shadow: 1px 1px gray;
	font-weight: bold; background: rgba(0, 0, 0, 0.5); color: #555;
	border-radius: 3px; margin-right: 2px; cursor: pointer; }
table input[type='checkbox'] { display: none; }

table input:checked + label { color: white; text-shadow: 1px 1px black; }
table input:checked.debut + label { background-color: #00e; }
table input:checked.regular + label { background-color: #ba0; }
table input:checked.pro + label { background-color: #a00; }
table input:checked.master + label { background: linear-gradient(to right, #f66, #66f, #ff5); }
</style>
</head>

<body>

<h1>Clear Checker</h1>

<table id="list">
<tbody></tbody>
</table>
<div id="summary"></div>
<label><input type="checkbox" id="hideLimited">限定曲を隠す</label>
<ul>
<li>最新のブラウザでご利用ください。</li>
<li>すべてのデータはこれを起動している<strong>ブラウザに保存</strong>され、外部サーバには送信・蓄積されません。</li>
</ul>

<script src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
<script>
var levels = ['debut', 'regular', 'pro', 'master'];
var musics;

$.get('musics.csv')
.then(function(text) {
	var table = $('#list tbody');
	musics = text.split(/\n/).map(function(line) { return line.split(','); });

	musics.forEach(function(music) {
		var id = music[0];
		var title  = music[1];
		var attr = music[2];
		var limited = !!music[3];
		if (!title) return;
		var tr = $('<tr>').addClass(attr).toggleClass('limited', limited).data('music-id', id).appendTo(table);
		$('<td>').text(title).appendTo(tr);
		var cell = $('<td class="check">').appendTo(tr);
		levels.forEach(function(dif) {
			var cid = 'm-' + id + '-' + dif;
			var check = $('<input type="checkbox">').attr('id', cid).addClass(dif).appendTo(cell);
			var label = $('<label>').attr('for', cid).appendTo(cell).text(dif.toUpperCase());
		});
	});

	var tmp = localStorage.getItem('clearData');
	var clearData = {};
	try {
		if (typeof tmp == 'string' && tmp.length > 0) clearData = JSON.parse(tmp);
	} catch (e) {
		//
	}
	load(clearData);
});

$('table').on('click', 'input', update);

$('#hideLimited').click(function() {
	$('tr.limited').toggle(!$(this).is(':checked'));
});

function update() {
	var total = 0;
	var counts = levels.map(function(dif) {
		var count = $('input:checked').filter('.' + dif).length;
		total += count;
		return dif + " " + count + '/' + musics.length;
	});
	$('#summary').text(counts.join('; ') + '; total ' + total + '/' + musics.length * levels.length);
	save();
}

function load(data) {
	$('#list tr').each(function () {
		var id = $(this).data('music-id');
		$(':checkbox', this).each(function () {
			var dif = $(this).attr('class');
			$(this).prop('checked', id in data && data[id][dif]);
		});
	});
	update();
}

function save() {
	var data = {};
	$('#list tr').each(function () {
		var id = $(this).data('music-id');
		var flags = {};
		$('input', this).each(function (input) {
			flags[$(this).attr('class')] = $(this).is(':checked')
		});
		data[id] = flags;
	});
	localStorage.setItem('clearData', JSON.stringify(data));
	$('#url').text(url);
}


</script>
</body>
